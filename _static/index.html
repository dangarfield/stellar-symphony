<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stellar Symphony</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <style>
        .constellations .constellation canvas {
            width: 200px;
        }

        .tone-clip:hover {
            cursor: pointer;
        }

        .star-map {
            position: relative;
        }

        .label {
            color: #FFF;
            font-family: sans-serif;
            padding: 2px;
            background: rgba(0, 0, 0, .6);
            font-family: 12px;
        }
    </style>
</head>

<body>
    <div class="container-fluid constellations">
        <!-- <canvas id="myChart"></canvas> -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-colorschemes"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.40/Tone.min.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>

    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/build/three.min.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/examples/jsm/controls/OrbitControls.js" type="module"></script> -->

    <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three@0.143.0/build/three.module.js"
            }
        }
    </script>


    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.143.0/build/three.module.js';
        import { OrbitControls} from 'https://unpkg.com/three@0.143.0/examples/jsm/controls/OrbitControls.js';
        // import { PointerLockControls } from 'https://unpkg.com/three@0.143.0/examples/jsm/controls/PointerLockControls.js';
        import { Line2 } from 'https://unpkg.com/three@0.143.0/examples/jsm/lines/Line2.js';
        import { LineMaterial } from 'https://unpkg.com/three@0.143.0/examples/jsm/lines/LineMaterial.js';
        import { LineGeometry } from 'https://unpkg.com/three@0.143.0/examples/jsm/lines/LineGeometry.js';
		import { CSS2DRenderer, CSS2DObject } from 'https://unpkg.com/three@0.143.0/examples/jsm/renderers/CSS2DRenderer.js';

        const getColor = (i) => {
            const Tableau20 = ["#4E79A7", "#A0CBE8", "#F28E2B", "#FFBE7D", "#59A14F", "#8CD17D", "#B6992D", "#F1CE63",
                "#499894", "#86BCB6", "#E15759", "#FF9D9A", "#79706E", "#BAB0AC", "#D37295", "#FABFD2", "#B07AA1", "#D4A6C8", "#9D7660", "#D7B5A6"
            ]
            return Tableau20[i % 20]
        }
        console.log('Chart', getColor(0), getColor(19), getColor(20))
        // Chart.defaults.global.defaultFontFamily = "Helvetica Neue";

        const stopToneClips = () => {
            Tone.Transport.stop();
            Tone.Transport.cancel(0);
        }
        const noteToMidi = (lengthBarSec, lengthBeatSec, lengthSubDSec, chordNotesFlat) => {
            return chordNotesFlat.map(n => {
                let bars = 0
                let beats = 0
                let subdivisions = 0
                const timeSplit = n.time.split(':')
                if(timeSplit.length>0) bars = parseInt(timeSplit[0])
                if(timeSplit.length>1) beats = parseInt(timeSplit[1])
                if(timeSplit.length>2) subdivisions = parseInt(timeSplit[2])
                const durationSplit = n.duration.split('')
                const durationCount = parseInt(durationSplit[0])
                let durationOneLength = lengthBeatSec
                switch (durationSplit[1]) {
                    case 'n':
                        durationOneLength = lengthBeatSec
                        break;
                }
                const duration = durationCount * durationOneLength

                let timeSeconds = (bars * lengthBarSec) + (beats * lengthBeatSec) + (subdivisions * lengthSubDSec)

                const midiNote = {
                    // bars,
                    // beats,
                    // subdivisions,
                    midi: Tonal.Note.midi(n.note),
                    time: timeSeconds,
                    // ticks: secondsToTicks(timeSeconds),
                    // name: n.note,
                    // pitch: n.note.slice(0, -1),
                    // octave: parseInt(n.note.slice(-1)),
                    velocity: 1,
                    duration: duration
                }
                console.log('converting note', n, midiNote)
                return midiNote
            })
        }
        const convertNotesToMidi = (timeSig, bpm, chordNotes, melodyNotes) => {

            // Assumed 4/4
            const beatsInMeasure = timeSig[0]
            const beatsLength = timeSig[1]
            const lengthBeatSec = Math.pow(bpm/60,-1)
            const lengthSubDSec = lengthBeatSec / beatsLength
            const lengthBarSec = lengthBeatSec * beatsInMeasure

            const midi = new Midi()
            midi.header.name = 'Stella Symphony'
            midi.header.setTempo(bpm)
            midi.header.timeSignatures.push({ticks:0,timeSignature:beatsInMeasure,measures:beatsLength})



            console.log('bars/beat/subd', lengthBarSec, lengthBeatSec, lengthSubDSec)
            // Chords
            const chordsTrack = midi.addTrack()
            chordsTrack.name = 'Chords'
            chordsTrack.channel = 1
            // console.log('chordNotes', chordNotes)
            const chordNotesFlat = chordNotes.flatMap((x) => Array.isArray(x.note) ? x.note.flatMap((d) => ({ time: x.time, duration:x.duration, note:d })) : x);
            const chordMidiNotes = noteToMidi(lengthBarSec, lengthBeatSec, lengthSubDSec, chordNotesFlat)
            console.log('chordMidiNotes', chordMidiNotes)
            for (const note of chordMidiNotes) {
                chordsTrack.addNote(note)
            }
            // Chords
            const melodyTrack = midi.addTrack()
            melodyTrack.name = 'Melody'
            melodyTrack.channel = 2
            // console.log('melodyNotes', melodyNotes)
            const melodyNotesFlat = melodyNotes.flatMap((x) => Array.isArray(x.note) ? x.note.flatMap((d) => ({ time: x.time, duration:x.duration, note:d })) : x);
            const melodyMidiNotes = noteToMidi(lengthBarSec, lengthBeatSec, lengthSubDSec, melodyNotesFlat)
            console.log('melodyMidiNotes', melodyMidiNotes)
            for (const note of melodyMidiNotes) {
                melodyTrack.addNote(note)
            }
            console.log('midi', midi)
            console.log('midi.toArray()', midi.toArray())
            // new Blob([new Buffer(midi.toArray())]);

            let link = document.createElement('a');
            link.download = 'test.mid';

            let blob = new Blob([midi.toArray()], {type: 'audio/midi'})

            link.href = URL.createObjectURL(blob);

            link.click();

            URL.revokeObjectURL(link.href);



        }
        const playToneClip = (toneData) => {
            // console.log('playToneClip', toneData)
            stopToneClips()
            if (toneData.type === 'scale') {
                const scaleNotes = Tonal.Scale.get(toneData.scale.chroma).intervals.map(Tonal.Note.transposeFrom('C')).map(v => (v) + '4')
                scaleNotes.push('C5')
                const synth = new Tone.Synth().toDestination()
                var pattern = new Tone.Pattern(function(time, note) {
                    synth.triggerAttackRelease(note, "4n", time)
                }, scaleNotes, 'up').start(0)
                Tone.Transport.bpm.value = 120

            } else if (toneData.type === 'chords' || toneData.type === 'melody') {

                const synth = new Tone.PolySynth().toDestination();

                const bpm = 80
                const timeSig = [4,4]
                const chordNotes = []
                const melodyNotes = []
                for (let i = 0; i < toneData.chords.length; i++) {
                    const chord = toneData.chords[i]
                    const notesInChord = chord.notes.slice(0, 3).map(n => Tonal.Note.transpose(n, '-8P'))
                    let decorationNote = chord.notes.length > 3 ? Tonal.Note.transpose(Tonal.Note.transpose(chord.notes[3], '-8P'), '-8P') : false
                    chordNotes.push({
                        time: `${i}:0`,
                        note: notesInChord,
                        duration: '2n'
                    }, {
                        time: `${i}:2`,
                        note: notesInChord,
                        duration: '2n'
                    })
                    if (decorationNote) {
                        chordNotes.push({
                            time: `${i}:1`,
                            note: decorationNote,
                            duration: '2n'
                        }, {
                            time: `${i}:3`,
                            note: decorationNote,
                            duration: '4n'
                        })
                    }
                }

                if (toneData.melody) {
                    for (const melodyNote of toneData.melody) {
                        melodyNotes.push({
                            time: melodyNote.timing,
                            note: melodyNote.note,
                            duration: melodyNote.duration
                        })
                    }
                }

                convertNotesToMidi(timeSig, bpm, chordNotes, melodyNotes)
                const notesToPlay = chordNotes.concat(melodyNotes)

                // note: 'C4',
                // timing: `${Math.floor(noteCount/4)}:${noteCount%4}`,
                // duration: '8n'


                const part = new Tone.Part(((time, value) => {
                        // the value is an object which contains both the note and the velocity
                        synth.triggerAttackRelease(value.note, value.duration, time)
                    }),
                    notesToPlay
                ).start(0)

                part.loop = true;
                part.loopEnd = "4m";

                Tone.Transport.bpm.value = bpm
            }
            Tone.Transport.start()

        }
        const sort = (list) => {
            list.sort(function(a, b) {
                return a - b
            })
        }

        const chromaDifference = (a, b) => {
            const as = a.split('')
            const bs = b.split('')
            let diff = 0
            for (let i = 0; i < as.length; i++) {
                if (as[i] !== bs[i]) {
                    diff++
                }
            }
            return diff
        }
        const adjustBucketValue = (value, max, total) => {
            return Math.min(Math.abs(Math.round((value / max) * total)), total)
        }
        const toRomanNumeral = (i) => {
            if (i === 1) {
                return 'I'
            } else if (i === 2) {
                return 'II'
            } else if (i === 3) {
                return 'III'
            } else if (i === 4) {
                return 'IV'
            } else if (i === 5) {
                return 'V'
            } else if (i === 6) {
                return 'VI'
            } else if (i === 7) {
                return 'VII'
            }
            return i
        }
        const getTriad = (scale, interval, decoration) => {
            const scaleChromaArray = scale.chroma.split('')
            const tripleOctave = [...scaleChromaArray].concat(scaleChromaArray, scaleChromaArray).map((v, i) => ({
                v: v,
                i: i
            }))
            const tripleOctaveFiltered = tripleOctave.filter(v => v.v === '1')
            // console.log('tripleOctave', tripleOctave, tripleOctaveFiltered)

            const intervalNotes = [interval + 1 - 1, interval + 3 - 1, interval + 5 - 1]

            const notesForChord = intervalNotes.map(v => tripleOctaveFiltered[v - 1])
            // console.log('notesForChord', intervalNotes, notesForChord, scale.chroma)
            if (decoration && decoration > 0) {
                notesForChord.push(tripleOctaveFiltered[interval + decoration - 1 - 1])
            }
            return notesForChord.map(v => v.i)
        }
        const getNotesForChordSemitones = (chord) => {
            return chord.map(v => Tonal.Note.transpose('C4', Tonal.Interval.fromSemitones(v)))
        }
        const getChords = (bucketValues, bucketPositions, max, scale) => {
            const maxIntervals = 7
            const chords = []
            for (const bucketPosition of bucketPositions) {
                const value = bucketValues[bucketPosition]
                const interval = 1 + adjustBucketValue(value, max, maxIntervals - 1)
                // console.log('chords value', bucketPosition, value, interval)
                let decorationValue = parseInt(value.toFixed(5).replace(/\D/g, ''))
                let decoration = false
                if (decorationValue % 6 === 0) {
                    decoration = 13
                } else if (decorationValue % 4 === 0) {
                    decoration = 11
                } else if (decorationValue % 2 === 0) {
                    decoration = 9
                }
                // console.log('decorationValue', decorationValue, decorationValue % 2 === 0, decorationValue % 4 === 0, decorationValue % 6 === 0, '->', decoration)
                const chord = getTriad(scale, interval, decoration)
                const chordObj = {
                    interval,
                    chord,
                    notes: getNotesForChordSemitones(chord)
                }
                if (decoration) {
                    chordObj.decoration = decoration
                }

                // console.log('chord', chordObj)
                chords.push(chordObj)
            }
            return chords
        }
        const getScale = (bucketValues) => {
            let scale = [...bucketValues]
            scale.sort((a, b) => Math.abs(b) - Math.abs(a))
            scale = scale.slice(0, 6).map(v => v > 0)
            // Use chroma. for the 6 pairs, set 2 or b2 etc for all, then use chroma to find a found scale, removing one note as required until a match

            const chromaString = new Array(12).fill(0)
            chromaString[0] = 1

            for (let i = 0; i < scale.length; i++) {
                const noteValue = scale[i]
                if (i === 0 || i === 1) {
                    chromaString[(i + 1) * 2 - (noteValue ? 0 : 1)] = 1
                } else if (i === 4 || i === 5) {
                    chromaString[((i + 1) * 2) - 1 - (noteValue ? 0 : 1)] = 1
                } else if (i === 2 || i === 3) {
                    chromaString[i + 4 - (noteValue ? 0 : 1)] = 1
                }
            }
            const chroma = chromaString.join('')
            const allScales = Tonal.ScaleType.all().filter(s => s.intervals.length === 7)
            for (const potentialScale of allScales) {
                const distance = chromaDifference(chroma, potentialScale.chroma)
                potentialScale.distance = distance
            }
            // allScales.sort((a, b) => a.distance - b.distance)

            allScales.sort((a, b) => {
                function findFirstDiffPos(a, b) {
                    if (a.length < b.length)[a, b] = [b, a]
                    return [...a].findIndex((chr, i) => chr !== b[i])
                }
                return a.distance - b.distance || findFirstDiffPos(b.chroma.split(''), chroma) - findFirstDiffPos(a.chroma.split(''), chroma)
            })


            // console.log('allScales', chroma, allScales, allScales.map(s => `${chroma} : ${s.chroma} - ${s.distance} - ${s.name}`))

            // const scaleFound = allScales[0]
            // console.log('scaleFound', scaleFound)
            return allScales[0]
        }


        // Potential melodies (da - distance from alpha, dc - distance from centre, aa - angle from alpha, ac - angle from centre)
        // # - timing - notes
        // 1 - da - aa
        // 2 - da - ac
        // 3 - dc - aa
        // 4 - dc - ac
        // 5 - aa - da
        // 6 - aa - dc
        // 7 - ac - da
        // 8 - ac - dc


        // Melody 1 Timing = distance from alpha
        // Melody 1 Notes =  angle from centre

        const getMelodyTimingByDistance = (stars, scale, distanceAttribute, angleAttribute) => {
            const melodyStars = stars//.filter(s => s.bayer !== '')
            melodyStars.sort((a, b) => a[distanceAttribute] - b[distanceAttribute])
            // melodyStars.sort((a, b) => a.distanceFromCentre - b.distanceFromCentre) // Could also use distanceFromCentre

            // 15 notes -> 4 bars, across total 32 half notes
            // 7 notes -> 2 bars, acrodd total 16 half notes
            // 3 notes -> 2 bars, across total 16 half notes
            const totalBars = melodyStars.length >= 7 ? 4 : 2
            const totalNoteCount = (8 * totalBars) - 1
            const timeFactor = melodyStars[melodyStars.length - 1][distanceAttribute] / totalNoteCount
            // const timeFactor = melodyStars[melodyStars.length - 1].distanceFromCentre / totalNoteCount

            const scaleNotes = scale.intervals.map(Tonal.Note.transposeFrom('C')).map(v => (v) + '5')

            // console.log('scaleNotes', scaleNotes, scale)
            const melody = melodyStars.map((s, i) => {
                const noteCount = Math.round(s[distanceAttribute] / timeFactor)
                const note = scaleNotes[Math.floor((s[angleAttribute]%180)/(180/7))]
                return {
                    noteCount: noteCount,
                    note: note,//scaleNotes[i % scaleNotes.length],
                    timing: `${Math.floor(noteCount/8)}:${Math.floor(noteCount/2)%4}:${noteCount%2===1?2:0}`,
                    duration: '8n' // Todo lengths
                }
            }) // TODO - fill out any notes played at the same time?

            // console.log('melody stars', melodyStars, '-', totalBars, totalNoteCount, timeFactor, '-', melody)
            return melody
        }
        // Melody 2 Timing = angle from centre
        // Melody 2 Notes = distance from centre
        const getMelodyTimingByAngle = (stars, scale, distanceAttribute, angleAttribute) => {
            const melodyStars = stars//.filter(s => s.bayer !== '')
            melodyStars.sort((a, b) => a[angleAttribute] - b[angleAttribute])

            const totalBars = melodyStars.length >= 7 ? 4 : 2
            const totalNoteCount = (8 * totalBars) - 1
            const timeFactor = 360 / totalNoteCount

            // console.log('melody2 timefactor', totalNoteCount, timeFactor)

            const scaleNotes = scale.intervals.map(Tonal.Note.transposeFrom('C')).map(v => (v) + '5')
            scaleNotes.push('C5')
            const maxDistance = _.maxBy(melodyStars, distanceAttribute)[distanceAttribute]



            const melody = melodyStars.map((s, i) => {
                const noteCount = Math.round(s[angleAttribute]/timeFactor)
                // const note = scaleNotes[Math.floor((s[angleAttribute]%180)/(180/7))]
                const note = scaleNotes[Math.floor((s[distanceAttribute]/maxDistance) * (scaleNotes.length-1))]

                // console.log('star', s.bayer, s.proper, '-', s[angleAttribute], noteCount, '-', scaleNotes, s[distanceAttribute], s[distanceAttribute]/maxDistance, (s[distanceAttribute]/maxDistance) * (scaleNotes.length-1), note)
                return {
                    noteCount: noteCount,
                    note: note,//scaleNotes[i % scaleNotes.length],
                    timing: `${Math.floor(noteCount/8)}:${Math.floor(noteCount/2)%4}:${noteCount%2===1?2:0}`,
                    duration: '8n' // Todo lengths
                }
            })

            return melody
        }
        const getToneDataFromElementAndPlay = (starData, ele) => {
            const type = ele.getAttribute('data-type')
            const constellationId = ele.getAttribute('data-constellation')
            const constellation = starData.constellations.find(c => c.constellation === constellationId)

            let toneData = {}
            switch (type) {
            case 'scale':
            toneData = {type:'scale',scale:constellation.scale}
            break;
            case 'chords':
            toneData = {type:'chords',chords:constellation.chords}
            break;
            case 'melody':
            toneData = {type:'chords',chords:constellation.chords, melody:constellation.melody}
            break;
            case 'melody2':
            toneData = {type:'chords',chords:constellation.chords, melody:constellation.melody2}
            break;

            default:
            break;
            }
            console.log('.tone-clip click', type, constellationId, constellation, toneData)
            playToneClip(toneData)
        }

        const updateSelectedConstellation = (starData, constellationId, moveMap) => {
            // console.log('updateSelectedConstellation', starData.selectedConstellation ,constellationId,starData.selectedConstellation !== constellationId)
            if(starData.selectedConstellation !== constellationId) {
                starData.selectedConstellation = constellationId
                const constellation = starData.constellations.find(c => c.constellation === constellationId)
                if (moveMap) {
                    starData.focusMapOnConstellation(constellation)
                }
                const selectedConstellationHtml = `
                <h5 class="mt-3">${constellation.constellationName} - ${constellation.constellation}</h5>
                <p>Scale: ${constellation.scaleText}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="scale">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>
                <p>Chords: ${constellation.chordsText}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="chords">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>
                <p>Melody: ${constellation.melodyText}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="melody">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>

                <p>Melody2: ${constellation.melody2Text}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="melody2">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>
                `
                document.querySelector('.selected-constellation').innerHTML = selectedConstellationHtml
                for (const button of document.querySelectorAll('.selected-constellation .tone-clip')) {
                    button.addEventListener('click', function() {
                    // console.log('this', this)\
                    getToneDataFromElementAndPlay(starData, this)
                })
                }
                console.log('updated selected constellation', constellationId)

            }
        }
        const addConstellationGraphs = (starData) => {
            const dataAbsmagAll = {
                label: `ALL - absmag - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.absmag.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataMagAll = {
                label: `ALL - mag - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.mag.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataRVAll = {
                label: `ALL - rv - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.rv.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataLumAll = {
                label: `ALL - lum - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.lum.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataCiAll = {
                label: `ALL - ci - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.ci.averages,
                borderWidth: 1,
                hidden: true
            }


            const scaleList = []
            const chordList = []



            for (const [i, constellationData] of starData.constellations.entries()) {
                console.log(`Processing ${i+1} of ${starData.constellations.length} - ${constellationData.constellationName} - ${constellationData.constellation}`)
                // console.log('constellationData', constellationData)
                const div = document.createElement('div')
                div.classList.add('constellation')
                div.setAttribute('data-constellation', constellationData.constellation)

                // const absmagList = []
                // const magList = []
                // const rvList = []
                // const lumList = []
                // const ciList = []
                // const hrList = []


                // for (const star of constellationData.stars) {
                //     if (star.absmag) {
                //         absmagList.push(star.absmag)
                //     }
                //     if (star.mag) {
                //         magList.push(star.mag)
                //     }
                //     if (star.rv) {
                //         rvList.push(star.rv)
                //     }
                //     if (star.lum) {
                //         lumList.push(star.lum)
                //     }
                //     if (star.ci) {
                //         ciList.push(star.ci)
                //     }
                //     if (star.absmag && star.ci) {
                //         hrList.push({
                //             x: star.ci,
                //             y: star.absmag
                //         })
                //     }
                // }
                // const absmagMainList = []
                // const magMainList = []
                // const rvMainList = []
                // const lumMainList = []
                // const ciMainList = []
                // const hrMainList = []
                // for (const star of constellationData.starsMain) {
                //     if (star.hip === '69673') {
                //         console.log('Acturus', star)
                //     }
                //     if (star.absmag) {
                //         absmagMainList.push(star.absmag)
                //     }
                //     if (star.mag) {
                //         magMainList.push(star.mag)
                //     }
                //     if (star.rv) {
                //         rvMainList.push(star.rv)
                //     }
                //     if (star.lum) {
                //         lumMainList.push(star.lum)
                //     }
                //     if (star.ci) {
                //         ciMainList.push(star.ci)
                //     }
                // }
                // sort(absmagList)
                // sort(magList)
                // sort(rvList)
                // sort(lumList)
                // sort(ciList)
                // sort(absmagMainList)
                // sort(magMainList)
                // sort(rvMainList)
                // sort(lumMainList)
                // sort(ciMainList)

                // const hrDataset = {
                //     label: `${constellationData.constellation} - hr`,
                //     backgroundColor: getColor(i),
                //     borderColor: getColor(i),
                //     data: constellationData.diffs.hrList
                // }

                // console.log('list', absmagList, magList)
                const absmagConstellationDiff = {
                    label: `${constellationData.constellation} - absmag - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.absmag.diffs,
                    borderWidth: 1
                }
                // absmagConstellationDiffList.push(absmagConstellationDiff)
                const magConstellationDiff = {
                    label: `${constellationData.constellation} - mag - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.mag.diffs,
                    borderWidth: 1
                }
                // magConstellationDiffList.push(magConstellationDiff)
                const rvConstellationDiff = {
                    label: `${constellationData.constellation} - rv - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.rv.diffs,
                    borderWidth: 1
                }
                // rvConstellationDiffList.push(rvConstellationDiff)
                const lumConstellationDiff = {
                    label: `${constellationData.constellation} - lum - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.lum.diffs,
                    borderWidth: 1
                }
                // lumConstellationDiffList.push(lumConstellationDiff)
                const ciConstellationDiff = {
                    label: `${constellationData.constellation} - ci - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.ci.diffs,
                    borderWidth: 1
                }
                // ciConstellationDiffList.push(ciConstellationDiff)

                const scale = getScale(constellationData.ranges.mag.diffs)
                scaleList.push(scale)
                constellationData.scale = scale
                constellationData.scaleText = `${scale.name} - ${scale.chroma}`
                console.log('scale', scale)

                const chords = getChords(constellationData.ranges.absmag.diffs, [13, 14, 15, 16], 0.075, scale)
                constellationData.chords = chords
                constellationData.chordsText = chords.map(v => toRomanNumeral(v.interval) + (v.decoration?`add${v.decoration}`:'')).join(', ')
                chordList.push(chords)
                console.log('chords', chords)

                const melody = getMelodyTimingByDistance(constellationData.starsMain, scale, 'distanceFromAlpha', 'angleFromCentre')
                constellationData.melody = melody
                constellationData.melodyText = melody.map(m => `${m.note}-${m.timing}`).join(', ')

                const melody2 = getMelodyTimingByAngle(constellationData.starsMain, scale, 'distanceFromCentre', 'angleFromCentre')
                constellationData.melody2 = melody2
                constellationData.melody2Text = melody2.map(m => `${m.note}-${m.timing}`).join(', ')

                div.innerHTML = `
                    <div class="row">
                        <h3>${constellationData.constellationName} - ${constellationData.constellation}</h3>

                        <div class="col-3">
                            <p>Stars Total: ${constellationData.stars.length}</p>
                            <p>Stars Main Total: ${constellationData.starsMain.length}</p>
                        </div>
                        <div class="col-3">
                            <p>Scale: ${constellationData.scaleText}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="scale">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                            <p>Chords: ${constellationData.chordsText}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="chords">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                            <p>Melody: ${constellationData.melodyText}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="melody">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>

                            <p>Melody2: ${constellationData.melody2Text}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="melody2">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                        </div>
                        <div class="col-3">
                            <!--<p>Stars Main Total: ${constellationData.starsMain.length}</p>-->
                        </div>
                        <div class="col-3">
                            <!--<p>Stars Main Total: ${constellationData.starsMain.length}</p>-->
                        </div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-main"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-ave"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-ave-main"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                    </div>
                `

                document.querySelector('.constellations').appendChild(div)

                // Sorted all stars
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - absmag`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.absmagList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - mag`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.magList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - rv`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.rvList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - lum`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.lumList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - ci`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.ciList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })

                // Sorted main stars
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.absmagMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - mag - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.magMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - rv - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.rvMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - lum - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.lumMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - ci - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.ciMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })

                // AVERAGES - ALL
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.absmag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.absmag.averages,
                            borderWidth: 1,
                            hidden: true
                        }, absmagConstellationDiff, dataAbsmagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.mag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - mag - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.mag.averages,
                            borderWidth: 1,
                            hidden: true
                        }, magConstellationDiff, dataMagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.rv.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - rv - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.rv.averages,
                            borderWidth: 1,
                            hidden: true
                        }, rvConstellationDiff, dataRVAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.lum.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - lum - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.lum.averages,
                            borderWidth: 1,
                            hidden: true
                        }, lumConstellationDiff, dataLumAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.ci.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - ci - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.ci.averages,
                            borderWidth: 1,
                            hidden: true
                        }, ciConstellationDiff, dataCiAll]
                    }
                })
                // AVERAGES - MAIN
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.absmag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.absmag.averages,
                            borderWidth: 1
                        }, dataAbsmagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.mag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - mag - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.mag.averages,
                            borderWidth: 1
                        }, dataMagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.rv.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - rv - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.rv.averages,
                            borderWidth: 1
                        }, dataRVAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.lum.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - lum - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.lum.averages,
                            borderWidth: 1
                        }, dataLumAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.ci.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - ci - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.ci.averages,
                            borderWidth: 1
                        }, dataCiAll]
                    }
                })
            }

            const allDiv = document.createElement('div')
            allDiv.classList.add('all-constellation')

            allDiv.innerHTML = `<div class="row">
                <div class="col-12"><h3>Visual</h3></div>
                <div class="col-10 star-map"></div>
                <div class="col-2">
                    <h4>Constellations</h4>
                    <select class="form-select constellation-select">
                        <option style="display:none" value="">Select constellation</option>
                        ${starData.constellations.map(c => `<option value="${c.constellation}">${c.constellationName}</option>`)}
                    </select>
                    <div class="selected-constellation"></div>
                </div>
                <div class="col-12"><h3>All</h3></div>
                <div class="col-12"><canvas class="all-absmag"></canvas></div>
                <div class="col-12"><canvas class="all-mag"></canvas></div>
                <div class="col-12"><canvas class="all-rv"></canvas></div>
                <div class="col-12"><canvas class="all-lum"></canvas></div>
                <div class="col-12"><canvas class="all-ci"></canvas></div>
                <div class="col-12"><canvas class="all-hr"></canvas></div>
            </div>`
            document.querySelector('.constellations').prepend(allDiv)
            document.querySelector('.constellation-select').addEventListener('change', function() {
                const constellationId = this.value
                console.log('select constellation', constellationId)
                updateSelectedConstellation(starData, constellationId, true)
            })

            new Chart(document.querySelector(`.all-absmag`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.absmag.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.absmag.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - absmag - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-mag`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.mag.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.mag.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - mag - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-rv`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.rv.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.rv.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - rv - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-lum`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.lum.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.lum.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - lum - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-ci`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.ci.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.ci.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - ci - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            // Slows loading, leave commented for now
            // new Chart(document.querySelector(`.all-hr`), {
            //     type: 'scatter',
            //     data: {
            //         datasets: starData.hrAllListData.map((d,i) => ({
            //             label: `${d.constellation} - hr`,
            //             backgroundColor: getColor(i),
            //             borderColor: getColor(i),
            //             data: d.data
            //         }))
            //     },
            //     options: {
            //         scales: {
            //             y: {
            //                 reverse: true,
            //                 min: -5,
            //                 max: 17
            //             }
            //         }
            //     }
            // })

            function sumArrays(arrayList) {
                const total = new Array(arrayList[0].length).fill(0)
                for (const array of arrayList) {
                    for (let i = 0; i < array.length; i++) {
                        total[i] += array[i]
                    }
                }
                return total
            }

            // console.log('scaleList', scaleList, _.countBy(scaleList, 'name'), sumArrays((scaleList.map(s => s.chroma.split('').map(v => parseInt(v))))))


            for (const button of document.querySelectorAll('.tone-clip')) {
                button.addEventListener('click', function() {
                    // console.log('this', this)\
                    getToneDataFromElementAndPlay(starData, this)
                })
            }

        }

        function starVertexShader() {
            return `
                attribute float size;
                attribute vec3 customColor;
                varying vec3 vColor;

                void main() {
                    vColor = customColor;
                    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
                    gl_PointSize = size * ( 300.0 / -mvPosition.z );
                    gl_Position = projectionMatrix * mvPosition;
                }
            `
        }

        function starFragmentShader() {
            return `
                uniform vec3 color;
                uniform sampler2D pointTexture;
                varying vec3 vColor;
                void main() {
                    gl_FragColor = vec4( color * vColor, 1.0 );
                    gl_FragColor = gl_FragColor * texture2D( pointTexture, gl_PointCoord );
                }
            `
        }


        const addStarMap = async (starData) => {

            const updateFovFromDistance = () => {
                camera.fov = 25 + (controls.getDistance()*30)
                camera.updateProjectionMatrix()
            }
            const focusMapOnConstellation = (constellation) => {
                controls.enabled = false;
                const newCamPos = new THREE.Vector3(constellation.centre.x,constellation.centre.y,constellation.centre.z).lerp(new THREE.Vector3(0,0,0), 1.2)
                camera.position.x = newCamPos.x
                camera.position.y = newCamPos.y
                camera.position.z = newCamPos.z
                camera.lookAt( controls.target )

                controls.enabled = true

                updateFovFromDistance()
            }

            starData.focusMapOnConstellation = focusMapOnConstellation

            console.log('addStarMap', starData)
            var scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            var camera = new THREE.PerspectiveCamera(
                25, // Field of View
                1200 / 600, // aspect ratio
                0.001, // near clipping plane
                1000 // far clipping plane
            );
            var renderer = new THREE.WebGLRenderer({
                alpha: true, // transparent background
                antialias: true // smooth edges
            });
            renderer.setSize(1200, 600);
            document.querySelector('.star-map').appendChild(renderer.domElement);
            const labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize( 1200, 600 );
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none'
            document.querySelector('.star-map').appendChild( labelRenderer.domElement )

            const controls = new OrbitControls(camera, renderer.domElement);
            // controls.rotateSpeed *= -1; // This isn't working, should ideally be opposite up and down, scroll in / out, not pan
            controls.minDistance = 0
            controls.maxDistance = 1
            controls.zoomSpeed = 2
            // console.log('controls', controls)
            controls.addEventListener( 'change', function(change) {
                // camera.lookAt(new THREE.Vector3(0,0,0).lerp(camera.position, 2))
                updateFovFromDistance()
                // console.log('control change', controls.getDistance(), camera.fov)
            } );

            // var cube = new THREE.Mesh(new THREE.BoxGeometry(0.001, 0.001, 0.001), new THREE.MeshNormalMaterial())
            // scene.add(cube);

            // POINTS
            const sprite = new THREE.TextureLoader().load( 'disc.png' );

            const bufGeom = new THREE.BufferGeometry()
            const points = new THREE.Points(bufGeom, new THREE.ShaderMaterial({
            uniforms: {
            color: { value: new THREE.Color( 0xffffff ) },
            pointTexture: { value: new THREE.TextureLoader().load( 'disc.png' ) }
            },
            vertexShader: starVertexShader(),
            fragmentShader: starFragmentShader(),

            blending: THREE.AdditiveBlending,
            depthTest: false,
            transparent: true
            }))
            const pointsArray = []
            const colorsArray = []
            const sizesArray = []
            let targetCameraPos

            const centrePoints = []
            for (const constellation of starData.constellations) {//.filter(c => c.constellationName === 'Sagitta')) {

                const mainStarHips = constellation.starsMain.map(s => s.hip)
                for (const star of constellation.stars.filter(s => !mainStarHips.includes(s.hip))) {
                    pointsArray.push(star.ax, star.ay, star.az)
                    const s = ((star.mag * 26) / 255 + 0.18) / 75
                    // const s = 0.0125
                    sizesArray.push(s)
                    colorsArray.push(1,1,1,1)
                }
                for (const star of constellation.starsMain) {
                    pointsArray.push(star.ax, star.ay, star.az)
                    // const s = ((star.mag * 26) / 255 + 0.18) / 75
                    const s = 0.03
                    sizesArray.push(s)

                    if (star.alpha) {
                        colorsArray.push(1,0,0,1)
                    } else {
                        // colorsArray.push(0.82,0.89,1,1)
                        colorsArray.push(0,1,1,1)
                    }

                }
                pointsArray.push(constellation.centre.x, constellation.centre.y, constellation.centre.z)
                sizesArray.push(0.03)
                colorsArray.push(1,0,0,1)
                centrePoints.push({c: constellation.constellation, v: new THREE.Vector3(constellation.centre.x, constellation.centre.y, constellation.centre.z)})
            }
            // console.log('sizeArray', sizesArray)
            bufGeom.setAttribute('position', new THREE.Float32BufferAttribute(pointsArray, 3));
            bufGeom.setAttribute('customColor', new THREE.Float32BufferAttribute(colorsArray, 4));
            bufGeom.setAttribute('size', new THREE.Float32BufferAttribute(sizesArray, 1));

            scene.add(points)

            // LINES
            const lineMaterial = new LineMaterial({
                color: 0x1363DF,
                linewidth: 0.003
            })
            for (const constellation of starData.constellations) {
                for (const lines of constellation.lines) {
                    if(lines.points) {
                        const points = []
                        for (const point of lines.points) {
                            // points.push( new THREE.Vector3( point.x,point.y,point.z ) )
                            points.push(point.x,point.y,point.z)
                        }
                        // const lineGeom = new THREE.BufferGeometry().setFromPoints( points );
                        const lineGeom = new LineGeometry()
                        lineGeom.setPositions( points )
                        const line = new Line2( lineGeom, lineMaterial );
                        line.computeLineDistances();
                        line.scale.set( 1, 1, 1 );
                        scene.add( line );
                    }
                }

                const conDiv = document.createElement( 'div' );
                conDiv.className = 'label';
                conDiv.textContent = constellation.constellationName;

                // conDiv.style.marginTop = '-1em';
                const conLabel = new CSS2DObject( conDiv );
                conLabel.position.set( constellation.centre.x, constellation.centre.y, constellation.centre.z );
                scene.add( conLabel );

            }



            // SPHERE
            const sphere = new THREE.Mesh( new THREE.SphereGeometry( 1, 24, 13 ), new THREE.MeshPhongMaterial( { color: 0x12394C, side: THREE.DoubleSide, wireframe: true } ) )
            sphere.doubleSided = true;
            scene.add( sphere )
            scene.add( new THREE.AmbientLight( 0xFFFFFF ) )


            // TRIANGLES
            // for (const constellation of starData.constellations) {//.filter(c => c.constellationName === 'Ursa Major')) {
            //     const alpha = constellation.starsMain.find(s => s.alpha)
            //     const origin = {x: constellation.centre.x, y: constellation.centre.y, z: constellation.centre.z}
            //     // const origin = {x: alpha.ax, y: alpha.ay, z: alpha.az}
            //     const triGeom = new THREE.BufferGeometry()
            //     const triMesh = new THREE.Mesh(triGeom, new THREE.MeshBasicMaterial( {side: THREE.DoubleSide, transparent:false, color: 0xFFFFFF} ))
            //     const triPos = new Float32Array([0,0,0, origin.x,origin.y,origin.z, 0,1,0])
            //     triGeom.setAttribute('position', new THREE.BufferAttribute(triPos,3))
            //     scene.add(triMesh)
            //     for (const star of constellation.starsMain) {
            //         console.log('Angle to ', star.bayer, star.proper, '-', star.angleFromCentre, star.angleFromAlpha )
            //         const triGeom = new THREE.BufferGeometry()
            //         const triMesh = new THREE.Mesh(triGeom, new THREE.MeshBasicMaterial( {side: THREE.DoubleSide, transparent:false, color: 0xFF00FF} ))
            //         const triPos = new Float32Array([0,0,0, origin.x,origin.y,origin.z, star.ax, star.ay,star.az])
            //         triGeom.setAttribute('position', new THREE.BufferAttribute(triPos,3))
            //         scene.add(triMesh)
            //     }
            // }


            camera.lookAt(0,0,0)
            camera.position.z = 0.5; // move camera back so we can see the cube
            updateFovFromDistance()
            // camera.lookAt(new THREE.Vector3(0,0,0).lerp(camera.position, 2))

            // controls.update()

            // Ray casting
            const raycaster = new THREE.Raycaster();
            const pointer = new THREE.Vector2();
            function onPointerMove( event ) {
                pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
                pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
            }


            var render = function() {
                requestAnimationFrame(render)
                // controls.update()

                raycaster.setFromCamera( pointer, camera );
            	const intersects = raycaster.intersectObjects( [sphere] )
                if (intersects.length>0) {
                    const point = intersects[0].point
                    let dist = 100
                    let constellationId = ''
                    // console.log('point', point, centrePoints)
                    for (const centrePoint of centrePoints) {
                        const distPoint = centrePoint.v.distanceToSquared(point)
                        if(distPoint < dist ) {
                            dist = distPoint
                            constellationId = centrePoint.c
                        }
                    }
                    // console.log('Closest', constellationId)
                    updateSelectedConstellation(starData, constellationId, false)
                }



                renderer.render(scene, camera)
                labelRenderer.render( scene, camera )
            };
            updateSelectedConstellation(starData, starData.constellations[0].constellation, true)
            render();


        }
        const init = async () => {
            const starData = await (await fetch('/data/star-data.json')).json()
            // starData.constellations = starData.constellations.filter(c => c.constellation.includes('Pe'))

            console.log('starData', starData)
            addConstellationGraphs(starData)
            addStarMap(starData)
            document.body.addEventListener('keydown', function(e) {
                // console.log('e', e.code, e)
                if (e.code === 'Space' || e.code === 'Backspace' || e.code === 'Delete') {
                    stopToneClips()
                }
            })
            console.log('Ready')
        }
        init()
    </script>

</body>

</html>