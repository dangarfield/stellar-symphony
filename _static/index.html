<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stellar Symphony</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <style>
        .constellations .constellation canvas {
            width: 200px;
        }
    </style>
</head>

<body>
    <div class="container-fluid constellations">
        <!-- <canvas id="myChart"></canvas> -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-colorschemes"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.40/Tone.min.js"></script>
    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/build/three.min.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/examples/jsm/controls/OrbitControls.js" type="module"></script> -->

    <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three@0.143.0/build/three.module.js"
            }
        }
    </script>


    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.143.0/build/three.module.js';
        import { OrbitControls} from 'https://unpkg.com/three@0.143.0/examples/jsm/controls/OrbitControls.js';
        import { PointerLockControls } from 'https://unpkg.com/three@0.143.0/examples/jsm/controls/PointerLockControls.js';

        const getColor = (i) => {
            const Tableau20 = ["#4E79A7", "#A0CBE8", "#F28E2B", "#FFBE7D", "#59A14F", "#8CD17D", "#B6992D", "#F1CE63",
                "#499894", "#86BCB6", "#E15759", "#FF9D9A", "#79706E", "#BAB0AC", "#D37295", "#FABFD2", "#B07AA1", "#D4A6C8", "#9D7660", "#D7B5A6"
            ]
            return Tableau20[i % 20]
        }
        console.log('Chart', getColor(0), getColor(19), getColor(20))
        // Chart.defaults.global.defaultFontFamily = "Helvetica Neue";

        const stopToneClips = () => {
            Tone.Transport.stop();
            Tone.Transport.cancel(0);
        }
        const playToneClip = (toneData) => {
            // console.log('playToneClip', toneData)
            stopToneClips()
            if (toneData.type === 'scale') {
                const scaleNotes = Tonal.Scale.get(toneData.scale).intervals.map(Tonal.Note.transposeFrom('C')).map(v => (v) + '4')
                scaleNotes.push('C5')
                const synth = new Tone.Synth().toDestination()
                var pattern = new Tone.Pattern(function(time, note) {
                    synth.triggerAttackRelease(note, "4n", time)
                }, scaleNotes, 'up').start(0)
                Tone.Transport.bpm.value = 120

            } else if (toneData.type === 'chord' || toneData.type === 'melody') {

                const synth = new Tone.PolySynth().toDestination();

                const notesToPlay = []
                for (let i = 0; i < toneData.chords.length; i++) {
                    const chord = toneData.chords[i]
                    const notesInChord = chord.notes.slice(0, 3).map(n => Tonal.Note.transpose(n, '-8P'))
                    let decorationNote = chord.notes.length > 3 ? Tonal.Note.transpose(Tonal.Note.transpose(chord.notes[3], '-8P'), '-8P') : false
                    notesToPlay.push({
                        time: `${i}:0`,
                        note: notesInChord,
                        duration: '2n'
                    }, {
                        time: `${i}:2`,
                        note: notesInChord,
                        duration: '2n'
                    })
                    if (decorationNote) {
                        notesToPlay.push({
                            time: `${i}:1`,
                            note: decorationNote,
                            duration: '4n'
                        }, {
                            time: `${i}:3`,
                            note: decorationNote,
                            duration: '4n'
                        })
                    }
                }

                if (toneData.melody) {
                    for (const melodyNote of toneData.melody) {
                        notesToPlay.push({
                            time: melodyNote.timing,
                            note: melodyNote.note,
                            duration: melodyNote.duration
                        })
                    }
                }
                // note: 'C4',
                // timing: `${Math.floor(noteCount/4)}:${noteCount%4}`,
                // duration: '8n'


                const part = new Tone.Part(((time, value) => {
                        // the value is an object which contains both the note and the velocity
                        synth.triggerAttackRelease(value.note, value.duration, time)
                    }),
                    notesToPlay
                ).start(0)

                part.loop = true;
                part.loopEnd = "4m";

                Tone.Transport.bpm.value = 80
            }
            Tone.Transport.start()

        }
        const sort = (list) => {
            list.sort(function(a, b) {
                return a - b
            })
        }

        const chromaDifference = (a, b) => {
            const as = a.split('')
            const bs = b.split('')
            let diff = 0
            for (let i = 0; i < as.length; i++) {
                if (as[i] !== bs[i]) {
                    diff++
                }
            }
            return diff
        }
        const adjustBucketValue = (value, max, total) => {
            return Math.min(Math.abs(Math.round((value / max) * total)), total)
        }
        const toRomanNumeral = (i) => {
            if (i === 1) {
                return 'I'
            } else if (i === 2) {
                return 'II'
            } else if (i === 3) {
                return 'III'
            } else if (i === 4) {
                return 'IV'
            } else if (i === 5) {
                return 'V'
            } else if (i === 6) {
                return 'VI'
            } else if (i === 7) {
                return 'VII'
            }
            return i
        }
        const getTriad = (scale, interval, decoration) => {
            const scaleChromaArray = scale.chroma.split('')
            const tripleOctave = [...scaleChromaArray].concat(scaleChromaArray, scaleChromaArray).map((v, i) => ({
                v: v,
                i: i
            }))
            const tripleOctaveFiltered = tripleOctave.filter(v => v.v === '1')
            // console.log('tripleOctave', tripleOctave, tripleOctaveFiltered)

            const intervalNotes = [interval + 1 - 1, interval + 3 - 1, interval + 5 - 1]

            const notesForChord = intervalNotes.map(v => tripleOctaveFiltered[v - 1])
            // console.log('notesForChord', intervalNotes, notesForChord, scale.chroma)
            if (decoration && decoration > 0) {
                notesForChord.push(tripleOctaveFiltered[interval + decoration - 1 - 1])
            }
            return notesForChord.map(v => v.i)
        }
        const getNotesForChordSemitones = (chord) => {
            return chord.map(v => Tonal.Note.transpose('C4', Tonal.Interval.fromSemitones(v)))
        }
        const getChords = (bucketValues, bucketPositions, max, scale) => {
            const maxIntervals = 7
            const chords = []
            for (const bucketPosition of bucketPositions) {
                const value = bucketValues[bucketPosition]
                const interval = 1 + adjustBucketValue(value, max, maxIntervals - 1)
                // console.log('chords value', bucketPosition, value, interval)
                let decorationValue = parseInt(value.toFixed(5).replace(/\D/g, ''))
                let decoration = false
                if (decorationValue % 6 === 0) {
                    decoration = 13
                } else if (decorationValue % 4 === 0) {
                    decoration = 11
                } else if (decorationValue % 2 === 0) {
                    decoration = 9
                }
                // console.log('decorationValue', decorationValue, decorationValue % 2 === 0, decorationValue % 4 === 0, decorationValue % 6 === 0, '->', decoration)
                const chord = getTriad(scale, interval, decoration)
                const chordObj = {
                    interval,
                    chord,
                    notes: getNotesForChordSemitones(chord)
                }
                if (decoration) {
                    chordObj.decoration = decoration
                }

                // console.log('chord', chordObj)
                chords.push(chordObj)
            }
            return chords
        }
        const getScale = (bucketValues) => {
            let scale = [...bucketValues]
            scale.sort((a, b) => Math.abs(b) - Math.abs(a))
            scale = scale.slice(0, 6).map(v => v > 0)
            // Use chroma. for the 6 pairs, set 2 or b2 etc for all, then use chroma to find a found scale, removing one note as required until a match

            const chromaString = new Array(12).fill(0)
            chromaString[0] = 1

            for (let i = 0; i < scale.length; i++) {
                const noteValue = scale[i]
                if (i === 0 || i === 1) {
                    chromaString[(i + 1) * 2 - (noteValue ? 0 : 1)] = 1
                } else if (i === 4 || i === 5) {
                    chromaString[((i + 1) * 2) - 1 - (noteValue ? 0 : 1)] = 1
                } else if (i === 2 || i === 3) {
                    chromaString[i + 4 - (noteValue ? 0 : 1)] = 1
                }
            }
            const chroma = chromaString.join('')
            const allScales = Tonal.ScaleType.all().filter(s => s.intervals.length === 7)
            for (const potentialScale of allScales) {
                const distance = chromaDifference(chroma, potentialScale.chroma)
                potentialScale.distance = distance
            }
            // allScales.sort((a, b) => a.distance - b.distance)

            allScales.sort((a, b) => {
                function findFirstDiffPos(a, b) {
                    if (a.length < b.length)[a, b] = [b, a]
                    return [...a].findIndex((chr, i) => chr !== b[i])
                }
                return a.distance - b.distance || findFirstDiffPos(b.chroma.split(''), chroma) - findFirstDiffPos(a.chroma.split(''), chroma)
            })


            // console.log('allScales', chroma, allScales, allScales.map(s => `${chroma} : ${s.chroma} - ${s.distance} - ${s.name}`))

            // const scaleFound = allScales[0]
            // console.log('scaleFound', scaleFound)
            return allScales[0]
        }
        const getMelody = (stars, scale) => {
            const melodyStars = stars//.filter(s => s.bayer !== '')
            melodyStars.sort((a, b) => a.distanceFromAlpha - b.distanceFromAlpha)

            // 15 notes -> 4 bars, across total 32 half notes
            // 7 notes -> 2 bars, acrodd total 16 half notes
            // 3 notes -> 2 bars, across total 16 half notes
            const totalBars = melodyStars.length >= 7 ? 4 : 2
            const totalNoteCount = (8 * totalBars) - 1
            const timeFactor = melodyStars[melodyStars.length - 1].distanceFromAlpha / totalNoteCount

            const scaleNotes = scale.intervals.map(Tonal.Note.transposeFrom('C')).map(v => (v) + '5')

            console.log('scaleNotes', scaleNotes, scale)
            const melody = melodyStars.map((s, i) => {
                const noteCount = Math.round(s.distanceFromAlpha / timeFactor)
                return {
                    // bayer: s.bayer,
                    // distanceFromAlpha: s.distanceFromAlpha,
                    noteCount: noteCount,
                    note: scaleNotes[i % scaleNotes.length],
                    timing: `${Math.floor(noteCount/8)}:${Math.floor(noteCount/2)%4}:${noteCount%2===1?2:0}`,
                    duration: '8n' // Todo lengths
                }
            }) // TODO - fill out any notes played at the same time?

            console.log('melody stars', melodyStars, '-', totalBars, totalNoteCount, timeFactor, '-', melody)
            return melody
        }
        const addConstellationGraphs = (starData) => {
            const dataAbsmagAll = {
                label: `ALL - absmag - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.absmag.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataMagAll = {
                label: `ALL - mag - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.mag.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataRVAll = {
                label: `ALL - rv - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.rv.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataLumAll = {
                label: `ALL - lum - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.lum.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataCiAll = {
                label: `ALL - ci - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.ci.averages,
                borderWidth: 1,
                hidden: true
            }

            const absmagConstellationDiffList = [dataAbsmagAll]
            const magConstellationDiffList = [dataMagAll]
            const rvConstellationDiffList = [dataRVAll]
            const lumConstellationDiffList = [dataLumAll]
            const ciConstellationDiffList = [dataCiAll]
            const hrAllList = []

            const scaleList = []
            const chordList = []

            for (const [i, constellationData] of starData.constellations.entries()) {
                console.log(`Processing ${i+1} of ${starData.constellations.length} - ${constellationData.constellationName} - ${constellationData.constellation}`)
                // console.log('constellationData', constellationData)
                const div = document.createElement('div')
                div.classList.add('constellation')
                div.setAttribute('data-constellation', constellationData.constellation)

                const absmagList = []
                const magList = []
                const rvList = []
                const lumList = []
                const ciList = []
                const hrList = []


                for (const star of constellationData.stars) {
                    if (star.absmag) {
                        absmagList.push(star.absmag)
                    }
                    if (star.mag) {
                        magList.push(star.mag)
                    }
                    if (star.rv) {
                        rvList.push(star.rv)
                    }
                    if (star.lum) {
                        lumList.push(star.lum)
                    }
                    if (star.ci) {
                        ciList.push(star.ci)
                    }
                    if (star.absmag && star.ci) {
                        hrList.push({
                            x: star.ci,
                            y: star.absmag
                        })
                    }
                }
                const absmagMainList = []
                const magMainList = []
                const rvMainList = []
                const lumMainList = []
                const ciMainList = []
                const hrMainList = []
                for (const star of constellationData.starsMain) {
                    if (star.hip === '69673') {
                        console.log('Acturus', star)
                    }
                    if (star.absmag) {
                        absmagMainList.push(star.absmag)
                    }
                    if (star.mag) {
                        magMainList.push(star.mag)
                    }
                    if (star.rv) {
                        rvMainList.push(star.rv)
                    }
                    if (star.lum) {
                        lumMainList.push(star.lum)
                    }
                    if (star.ci) {
                        ciMainList.push(star.ci)
                    }
                }
                sort(absmagList)
                sort(magList)
                sort(rvList)
                sort(lumList)
                sort(ciList)
                sort(absmagMainList)
                sort(magMainList)
                sort(rvMainList)
                sort(lumMainList)
                sort(ciMainList)

                const hrDataset = {
                    label: `${constellationData.constellation} - hr`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: hrList
                }
                hrAllList.push(hrDataset)
                // console.log('list', absmagList, magList)
                const absmagConstellationDiff = {
                    label: `${constellationData.constellation} - absmag - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.absmag.averages.map((v, i) => v - starData.ranges.absmag.averages[i]),
                    borderWidth: 1
                }
                absmagConstellationDiffList.push(absmagConstellationDiff)
                const magConstellationDiff = {
                    label: `${constellationData.constellation} - mag - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.mag.averages.map((v, i) => v - starData.ranges.mag.averages[i]),
                    borderWidth: 1
                }
                magConstellationDiffList.push(magConstellationDiff)
                const rvConstellationDiff = {
                    label: `${constellationData.constellation} - rv - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.rv.averages.map((v, i) => v - starData.ranges.rv.averages[i]),
                    borderWidth: 1
                }
                rvConstellationDiffList.push(rvConstellationDiff)
                const lumConstellationDiff = {
                    label: `${constellationData.constellation} - lum - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.lum.averages.map((v, i) => v - starData.ranges.lum.averages[i]),
                    borderWidth: 1
                }
                lumConstellationDiffList.push(lumConstellationDiff)
                const ciConstellationDiff = {
                    label: `${constellationData.constellation} - ci - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.ci.averages.map((v, i) => v - starData.ranges.ci.averages[i]),
                    borderWidth: 1
                }
                ciConstellationDiffList.push(ciConstellationDiff)

                const scale = getScale(magConstellationDiff.data)
                scaleList.push(scale)
                // console.log('scale', scale)

                const chords = getChords(absmagConstellationDiff.data, [13, 14, 15, 16], 0.075, scale)
                chordList.push(chords)
                // console.log('chords', chords)

                const melody = getMelody(constellationData.starsMain, scale)

                div.innerHTML = `
                    <div class="row">
                        <h3>${constellationData.constellationName} - ${constellationData.constellation}</h3>

                        <div class="col-3">
                            <p>Stars Total: ${constellationData.stars.length}</p>
                            <p>Stars Main Total: ${constellationData.starsMain.length}</p>
                        </div>
                        <div class="col-3">
                            <p>Scale: ${scale.name} - ${scale.chroma}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-tone="${encodeURIComponent(JSON.stringify({type:'scale',scale:scale.chroma}))}">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                            <p>Chords: ${chords.map(v => toRomanNumeral(v.interval) + (v.decoration?`add${v.decoration}`:'')).join(', ')}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-tone="${encodeURIComponent(JSON.stringify({type:'chord',chords:chords}))}">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                            <p>Melody: ${melody.map(m => `${m.note}-${m.timing}`)}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-tone="${encodeURIComponent(JSON.stringify({type:'chord',chords:chords, melody:melody}))}">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                        </div>
                        <div class="col-3">
                            <!--<p>Stars Main Total: ${constellationData.starsMain.length}</p>-->
                        </div>
                        <div class="col-3">
                            <!--<p>Stars Main Total: ${constellationData.starsMain.length}</p>-->
                        </div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-main"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-ave"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-ave-main"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                    </div>
                `

                document.querySelector('.constellations').appendChild(div)

                // Sorted all stars
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - absmag`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: absmagList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - mag`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: magList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - rv`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: rvList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - lum`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: lumList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - ci`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: ciList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })

                // Sorted main stars
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: absmagMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - mag - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: magMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - rv - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: rvMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - lum - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: lumMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - ci - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: ciMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })

                // AVERAGES - ALL
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.absmag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.absmag.averages,
                            borderWidth: 1,
                            hidden: true
                        }, absmagConstellationDiff, dataAbsmagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.mag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - mag - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.mag.averages,
                            borderWidth: 1,
                            hidden: true
                        }, magConstellationDiff, dataMagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.rv.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - rv - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.rv.averages,
                            borderWidth: 1,
                            hidden: true
                        }, rvConstellationDiff, dataRVAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.lum.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - lum - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.lum.averages,
                            borderWidth: 1,
                            hidden: true
                        }, lumConstellationDiff, dataLumAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.ci.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - ci - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.ci.averages,
                            borderWidth: 1,
                            hidden: true
                        }, ciConstellationDiff, dataCiAll]
                    }
                })
                // AVERAGES - MAIN
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.absmag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.absmag.averages,
                            borderWidth: 1
                        }, dataAbsmagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.mag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - mag - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.mag.averages,
                            borderWidth: 1
                        }, dataMagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.rv.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - rv - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.rv.averages,
                            borderWidth: 1
                        }, dataRVAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.lum.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - lum - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.lum.averages,
                            borderWidth: 1
                        }, dataLumAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.ci.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - ci - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.ci.averages,
                            borderWidth: 1
                        }, dataCiAll]
                    }
                })
            }

            const allDiv = document.createElement('div')
            allDiv.classList.add('all-constellation')

            allDiv.innerHTML = `<div class="row">
                <h3>Visual</h3>
                <div class="col-12 star-map"></div>
                <h3>All</h3>
                <div class="col-12"><canvas class="all-absmag"></canvas></div>
                <div class="col-12"><canvas class="all-mag"></canvas></div>
                <div class="col-12"><canvas class="all-rv"></canvas></div>
                <div class="col-12"><canvas class="all-lum"></canvas></div>
                <div class="col-12"><canvas class="all-ci"></canvas></div>
                <div class="col-12"><canvas class="all-hr"></canvas></div>
            </div>`
            document.querySelector('.constellations').prepend(allDiv)
            new Chart(document.querySelector(`.all-absmag`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.absmag.averages.length
                    }, (_, i) => i + 1),
                    datasets: absmagConstellationDiffList
                }
            })
            new Chart(document.querySelector(`.all-mag`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.mag.averages.length
                    }, (_, i) => i + 1),
                    datasets: magConstellationDiffList
                }
            })
            new Chart(document.querySelector(`.all-rv`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.rv.averages.length
                    }, (_, i) => i + 1),
                    datasets: rvConstellationDiffList
                }
            })
            new Chart(document.querySelector(`.all-lum`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.lum.averages.length
                    }, (_, i) => i + 1),
                    datasets: lumConstellationDiffList
                }
            })
            new Chart(document.querySelector(`.all-ci`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.ci.averages.length
                    }, (_, i) => i + 1),
                    datasets: ciConstellationDiffList
                }
            })
            new Chart(document.querySelector(`.all-hr`), {
                type: 'scatter',
                data: {
                    datasets: hrAllList
                },
                options: {
                    scales: {
                        y: {
                            reverse: true,
                            min: -5,
                            max: 17
                        }
                    }
                }

            })

            function sumArrays(arrayList) {
                const total = new Array(arrayList[0].length).fill(0)
                for (const array of arrayList) {
                    for (let i = 0; i < array.length; i++) {
                        total[i] += array[i]
                    }
                }
                return total
            }

            // console.log('scaleList', scaleList, _.countBy(scaleList, 'name'), sumArrays((scaleList.map(s => s.chroma.split('').map(v => parseInt(v))))))


            for (const button of document.querySelectorAll('.tone-clip')) {
                button.addEventListener('click', function() {
                    // console.log('this', this)
                    const toneData = JSON.parse(decodeURIComponent(this.getAttribute('data-tone')))
                    // console.log('toneData', toneData)
                    playToneClip(toneData)
                })
            }
            addStarMap(starData)
        }

        const addStarMap = async (starData) => {
            console.log('addStarMap', starData)
            var scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            var camera = new THREE.PerspectiveCamera(
                75, // Field of View
                600 / 600, // aspect ratio
                0.001, // near clipping plane
                1000 // far clipping plane
            );
            var renderer = new THREE.WebGLRenderer({
                alpha: true, // transparent background
                antialias: true // smooth edges
            });

            renderer.setSize(600, 600);
            document.querySelector('.star-map').appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            // controls.rotateSpeed *= -1; // This isn't working, should ideally be opposite up and down, scroll in / out, not pan
            controls.minDistance = -1
            controls.maxDistance = 1
            // console.log('controls', controls)
            // controls.addEventListener( 'change', function(change) {
                // camera.lookAt(new THREE.Vector3(0,0,0).lerp(camera.position, 2))
                // console.log('control change', camera)
            // } );

            // var cube = new THREE.Mesh(new THREE.BoxGeometry(0.001, 0.001, 0.001), new THREE.MeshNormalMaterial())
            // scene.add(cube);

            // POINTS
            const bufGeom = new THREE.BufferGeometry()
            const points = new THREE.Points(bufGeom, new THREE.PointsMaterial({
                size: 0.01,
                color: 0x00FF00,
                // vertexColors: THREE.VertexColors
            }))
            const pointsArray = []
            const colorsArray = []
            let targetCameraPos
            for (const constellation of starData.constellations) {//.filter(c => c.constellationName === 'Sagitta')) {
                for (const star of constellation.starsMain) {
                    pointsArray.push(star.ax, star.ay, star.az)
                    colorsArray.push(0,1,0)
                }
                pointsArray.push(constellation.centre.x, constellation.centre.y, constellation.centre.z)
                colorsArray.push(1,0,0)
            }
            const vertices = new Float32Array(pointsArray)
            bufGeom.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            const colors = new Float32Array(colorsArray)
            bufGeom.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            // TODO - get colors working
            scene.add(points)

            // LINES
            const lineMaterial = new THREE.LineBasicMaterial({
                color: 0x0000ff
            });

            for (const constellation of starData.constellations) {
                for (const lines of constellation.lines) {
                    const points = []
                    for (const point of lines.points) {
                        points.push( new THREE.Vector3( point.x,point.y,point.z ) )
                    }
                    const lineGeom = new THREE.BufferGeometry().setFromPoints( points );

                    const line = new THREE.Line( lineGeom, lineMaterial );
                    scene.add( line );

                }

            }



            // SPHERE
            const sphere = new THREE.Mesh( new THREE.SphereGeometry( 1, 32, 16 ), new THREE.MeshPhongMaterial( { color: 0xffff00, side: THREE.DoubleSide, wireframe: true } ) )
            sphere.doubleSided = true;
            scene.add( sphere )
            scene.add( new THREE.AmbientLight( 0x444444 ) )



            camera.lookAt(0,0,0)
            camera.position.z = 0.5; // move camera back so we can see the cube
            // camera.lookAt(new THREE.Vector3(0,0,0).lerp(camera.position, 2))

            // controls.update()

            var render = function() {
                requestAnimationFrame(render);
                // controls.update()
                renderer.render(scene, camera);
                // console.log('render')
                // rotate cube a little each frame
                // cube.rotation.x += 0.01;
                // cube.rotation.y += 0.01;
            };

            render();
        }
        const init = async () => {
            const starData = await (await fetch('/data/star-data.json')).json()
            starData.constellations = starData.constellations.filter(c => c.constellation.includes('T'))

            console.log('starData', starData)
            addConstellationGraphs(starData)

            document.body.addEventListener('keypress', function(e) {
                // console.log('e', e)
                if (e.code === 'Space') {
                    stopToneClips()
                }
            })
            console.log('Ready')
        }
        init()
    </script>

</body>

</html>