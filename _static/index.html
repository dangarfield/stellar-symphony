<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stellar Symphony</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <style>
        .constellations .constellation canvas {
            width: 200px;
        }

        .tone-clip:hover {
            cursor: pointer;
        }

        .star-map {
            position: relative;
        }

        .label {
            color: #FFF;
            font-family: sans-serif;
            padding: 2px;
            background: rgba(0, 0, 0, .6);
            font-family: 12px;
        }
    </style>
</head>

<body>
    <div class="container-fluid constellations">
        <!-- <canvas id="myChart"></canvas> -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-colorschemes"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.40/Tone.min.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>

    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/build/three.min.js" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.143.0/examples/jsm/controls/OrbitControls.js" type="module"></script> -->

    <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three@0.143.0/build/three.module.js"
            }
        }
    </script>


    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.143.0/build/three.module.js';
        import { OrbitControls} from 'https://unpkg.com/three@0.143.0/examples/jsm/controls/OrbitControls.js';
        // import { PointerLockControls } from 'https://unpkg.com/three@0.143.0/examples/jsm/controls/PointerLockControls.js';
        import { Line2 } from 'https://unpkg.com/three@0.143.0/examples/jsm/lines/Line2.js';
        import { LineMaterial } from 'https://unpkg.com/three@0.143.0/examples/jsm/lines/LineMaterial.js';
        import { LineGeometry } from 'https://unpkg.com/three@0.143.0/examples/jsm/lines/LineGeometry.js';
		import { CSS2DRenderer, CSS2DObject } from 'https://unpkg.com/three@0.143.0/examples/jsm/renderers/CSS2DRenderer.js';

        const getColor = (i) => {
            const Tableau20 = ["#4E79A7", "#A0CBE8", "#F28E2B", "#FFBE7D", "#59A14F", "#8CD17D", "#B6992D", "#F1CE63",
                "#499894", "#86BCB6", "#E15759", "#FF9D9A", "#79706E", "#BAB0AC", "#D37295", "#FABFD2", "#B07AA1", "#D4A6C8", "#9D7660", "#D7B5A6"
            ]
            return Tableau20[i % 20]
        }
        // console.log('Chart', getColor(0), getColor(19), getColor(20))
        // Chart.defaults.global.defaultFontFamily = "Helvetica Neue";

        const stopToneClips = () => {
            Tone.Transport.stop();
            Tone.Transport.cancel(0);
        }

        const playToneClip = (toneData) => {
            // console.log('playToneClip', toneData)
            stopToneClips()
            if (toneData.type === 'scale') {
                const scaleNotes = Tonal.Scale.get(toneData.scale.chroma).intervals.map(Tonal.Note.transposeFrom('C')).map(v => (v) + '4')
                scaleNotes.push('C5')
                const synth = new Tone.Synth().toDestination()
                var pattern = new Tone.Pattern(function(time, note) {
                    synth.triggerAttackRelease(note, "4n", time)
                }, scaleNotes, 'up').start(0)
                Tone.Transport.bpm.value = 120

            } else if (toneData.type === 'chords' || toneData.type === 'melody') {

                const synth = new Tone.PolySynth().toDestination();

                const notesToPlay = toneData.melody ? toneData.chords.concat(toneData.melody) : toneData.chords

                const part = new Tone.Part(((time, value) => {
                        // the value is an object which contains both the note and the velocity
                        synth.triggerAttackRelease(value.note, value.duration, time)
                    }),
                    notesToPlay
                ).start(0)

                part.loop = true;
                part.loopEnd = "4m";

                Tone.Transport.bpm.value = toneData.bpm
            } else if (toneData.type === 'song') {
                const synth = new Tone.PolySynth().toDestination();
                // console.log('song', toneData)
                let notesToPlay = []
                for (const track of toneData.song) {
                    // console.log('track', track.notes)
                    notesToPlay = notesToPlay.concat(track.notes)
                }
                // toneData.melody ? toneData.chords.concat(toneData.melody) : toneData.chords

                // console.log('song', toneData, notesToPlay)
                const part = new Tone.Part(((time, value) => {
                    // the value is an object which contains both the note and the velocity
                    synth.triggerAttackRelease(value.note, value.duration, time)
                    }),
                    notesToPlay
                ).start(0)

                // part.loop = true;
                // part.loopEnd = "16m";

                Tone.Transport.bpm.value = toneData.bpm
            }
            Tone.Transport.start()

        }


        const toRomanNumeral = (i) => {
            if (i === 1) {
            return 'I'
            } else if (i === 2) {
            return 'II'
            } else if (i === 3) {
            return 'III'
            } else if (i === 4) {
            return 'IV'
            } else if (i === 5) {
            return 'V'
            } else if (i === 6) {
            return 'VI'
            } else if (i === 7) {
            return 'VII'
            }
            return i
        }

        // Potential melodies (da - distance from alpha, dc - distance from centre, aa - angle from alpha, ac - angle from centre)
        // # - timing - notes
        // 1 - da - aa
        // 2 - da - ac
        // 3 - dc - aa
        // 4 - dc - ac
        // 5 - aa - da
        // 6 - aa - dc
        // 7 - ac - da
        // 8 - ac - dc


        // Melody 1 Timing = distance from alpha
        // Melody 1 Notes =  angle from centre


        const getToneDataFromElementAndPlay = (starData, ele) => {
            const type = ele.getAttribute('data-type')
            const constellationId = ele.getAttribute('data-constellation')
            const constellation = starData.constellations.find(c => c.constellation === constellationId)

            let toneData = {bpm: constellation.music.bpm, timeSig: constellation.music.timeSig}
            switch (type) {
                case 'scale':
                    toneData.type = 'scale'
                    toneData.scale = constellation.music.scale
                    break;
                case 'chords':
                    toneData.type = 'chords'
                    toneData.chords = constellation.music.chords.toneNotes
                    break;
                case 'melody':
                    toneData.type = 'chords'
                    toneData.chords = constellation.music.chords.toneNotes
                    toneData.melody = constellation.music.melody
                    break;
                case 'melody2':
                    toneData.type = 'chords'
                    toneData.chords = constellation.music.chords.toneNotes
                    toneData.melody = constellation.music.melody2
                    break;
                case 'song':
                    toneData.type = 'song'
                    toneData.song = constellation.music.songNotes
                    break;
            }
            console.log('.tone-clip click', type, constellationId, constellation, toneData)
            playToneClip(toneData)
        }

        const updateSelectedConstellation = (starData, constellationId, moveMap) => {
            // console.log('updateSelectedConstellation', starData.selectedConstellation ,constellationId,starData.selectedConstellation !== constellationId)
            if(starData.selectedConstellation !== constellationId) {
                starData.selectedConstellation = constellationId
                const constellation = starData.constellations.find(c => c.constellation === constellationId)
                if (moveMap) {
                    starData.focusMapOnConstellation(constellation)
                }
                const selectedConstellationHtml = `
                <h5 class="mt-3">${constellation.constellationName} - ${constellation.constellation}
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="song">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span></h5>
                <p>Scale: ${constellation.music.scaleText}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="scale">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>
                <p>Chords: ${constellation.music.chords.text}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="chords">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>
                <p>Melody: ${constellation.music.melodyText}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="melody">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>

                <p>Melody2: ${constellation.music.melody2Text}<br />
                    <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellation.constellation}" data-type="melody2">
                                                                    <i class="bi bi-play-circle"></i>
                                                                </span>
                </p>
                `
                document.querySelector('.selected-constellation').innerHTML = selectedConstellationHtml
                for (const button of document.querySelectorAll('.selected-constellation .tone-clip')) {
                    button.addEventListener('click', function() {
                    // console.log('this', this)\
                    getToneDataFromElementAndPlay(starData, this)
                })
                }
                // console.log('updated selected constellation', constellationId)

            }
        }
        const addConstellationGraphs = (starData) => {
            const dataAbsmagAll = {
                label: `ALL - absmag - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.absmag.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataMagAll = {
                label: `ALL - mag - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.mag.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataRVAll = {
                label: `ALL - rv - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.rv.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataLumAll = {
                label: `ALL - lum - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.lum.averages,
                borderWidth: 1,
                hidden: true
            }
            const dataCiAll = {
                label: `ALL - ci - average`,
                backgroundColor: getColor(19),
                borderColor: getColor(19),
                data: starData.ranges.ci.averages,
                borderWidth: 1,
                hidden: true
            }




            for (const [i, constellationData] of starData.constellations.entries()) {
                console.log(`Processing ${i+1} of ${starData.constellations.length} - ${constellationData.constellationName} - ${constellationData.constellation}`)
                // console.log('constellationData', constellationData)
                const div = document.createElement('div')
                div.classList.add('constellation')
                div.setAttribute('data-constellation', constellationData.constellation)

                // console.log('list', absmagList, magList)
                const absmagConstellationDiff = {
                    label: `${constellationData.constellation} - absmag - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.absmag.diffs,
                    borderWidth: 1
                }
                // absmagConstellationDiffList.push(absmagConstellationDiff)
                const magConstellationDiff = {
                    label: `${constellationData.constellation} - mag - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.mag.diffs,
                    borderWidth: 1
                }
                // magConstellationDiffList.push(magConstellationDiff)
                const rvConstellationDiff = {
                    label: `${constellationData.constellation} - rv - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.rv.diffs,
                    borderWidth: 1
                }
                // rvConstellationDiffList.push(rvConstellationDiff)
                const lumConstellationDiff = {
                    label: `${constellationData.constellation} - lum - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.lum.diffs,
                    borderWidth: 1
                }
                // lumConstellationDiffList.push(lumConstellationDiff)
                const ciConstellationDiff = {
                    label: `${constellationData.constellation} - ci - diff`,
                    backgroundColor: getColor(i),
                    borderColor: getColor(i),
                    data: constellationData.ranges.ci.diffs,
                    borderWidth: 1
                }
                // ciConstellationDiffList.push(ciConstellationDiff)

                const scale = Tonal.ScaleType.get(constellationData.music.scale.chroma)
                constellationData.music.scaleText = `${scale.name} - ${scale.chroma}`

                constellationData.music.chords.text = constellationData.music.chords.structure.map(v => toRomanNumeral(v.interval) + (v.decoration?`add${v.decoration}`:'')).join(', ')

                constellationData.music.melodyText = constellationData.music.melody.map(m => `${m.note}-${m.time}`).join(', ')
                constellationData.music.melody2Text = constellationData.music.melody2.map(m => `${m.note}-${m.time}`).join(', ')

                div.innerHTML = `
                    <div class="row">
                        <h3>${constellationData.constellationName} - ${constellationData.constellation}</h3>

                        <div class="col-3">
                            <p>Stars Total: ${constellationData.stars.length}</p>
                            <p>Stars Main Total: ${constellationData.starsMain.length}</p>
                        </div>
                        <div class="col-3">
                            <p>Scale: ${constellationData.music.scaleText}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="scale">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                            <p>Chords: ${constellationData.music.chords.text}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="chords">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                            <p>Melody: ${constellationData.music.melodyText}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="melody">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>

                            <p>Melody2: ${constellationData.music.melody2Text}
                                <span class="badge rounded-pill text-bg-secondary tone-clip" data-constellation="${constellationData.constellation}" data-type="melody2">
                                    <i class="bi bi-play-circle"></i>
                                </span>
                            </p>
                        </div>
                        <div class="col-3">
                            <!--<p>Stars Main Total: ${constellationData.starsMain.length}</p>-->
                        </div>
                        <div class="col-3">
                            <!--<p>Stars Main Total: ${constellationData.starsMain.length}</p>-->
                        </div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-main"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-ave"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-ave"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>

                        <div class="col-3"><canvas class="${constellationData.constellation}-absmag-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-mag-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-rv-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-lum-ave-main"></canvas></div>
                        <div class="col-3"><canvas class="${constellationData.constellation}-ci-ave-main"></canvas></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                    </div>
                `

                document.querySelector('.constellations').appendChild(div)

                // Sorted all stars
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - absmag`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.absmagList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - mag`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.magList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - rv`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.rvList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - lum`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.lumList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - ci`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.ciList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })

                // Sorted main stars
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.absmagMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - mag - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.magMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - rv - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.rvMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - lum - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.lumMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-main`), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${constellationData.constellation} - ci - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.diffs.ciMainList.map((d, di) => {
                                return {
                                    y: d,
                                    x: di
                                }
                            })
                        }]
                    }
                })

                // AVERAGES - ALL
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.absmag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.absmag.averages,
                            borderWidth: 1,
                            hidden: true
                        }, absmagConstellationDiff, dataAbsmagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.mag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - mag - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.mag.averages,
                            borderWidth: 1,
                            hidden: true
                        }, magConstellationDiff, dataMagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.rv.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - rv - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.rv.averages,
                            borderWidth: 1,
                            hidden: true
                        }, rvConstellationDiff, dataRVAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.lum.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - lum - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.lum.averages,
                            borderWidth: 1,
                            hidden: true
                        }, lumConstellationDiff, dataLumAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-ave`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.ranges.ci.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - ci - average`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.ranges.ci.averages,
                            borderWidth: 1,
                            hidden: true
                        }, ciConstellationDiff, dataCiAll]
                    }
                })
                // AVERAGES - MAIN
                new Chart(document.querySelector(`.${constellationData.constellation}-absmag-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.absmag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - absmag - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.absmag.averages,
                            borderWidth: 1
                        }, dataAbsmagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-mag-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.mag.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - mag - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.mag.averages,
                            borderWidth: 1
                        }, dataMagAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-rv-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.rv.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - rv - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.rv.averages,
                            borderWidth: 1
                        }, dataRVAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-lum-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.lum.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - lum - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.lum.averages,
                            borderWidth: 1
                        }, dataLumAll]
                    }
                })
                new Chart(document.querySelector(`.${constellationData.constellation}-ci-ave-main`), {
                    type: 'line',
                    data: {
                        labels: Array.from({
                            length: constellationData.rangesMain.ci.averages.length
                        }, (_, i) => i + 1),
                        datasets: [{
                            label: `${constellationData.constellation} - ci - average - main`,
                            backgroundColor: getColor(i),
                            borderColor: getColor(i),
                            data: constellationData.rangesMain.ci.averages,
                            borderWidth: 1
                        }, dataCiAll]
                    }
                })
            }

            console.log('Drawing ALL graphs')
            const allDiv = document.createElement('div')
            allDiv.classList.add('all-constellation')

            allDiv.innerHTML = `<div class="row">
                <div class="col-12"><h3>Visual</h3></div>
                <div class="col-10 star-map"></div>
                <div class="col-2">
                    <h4>Constellations</h4>
                    <select class="form-select constellation-select">
                        <option style="display:none" value="">Select constellation</option>
                        ${starData.constellations.map(c => `<option value="${c.constellation}">${c.constellationName}</option>`)}
                    </select>
                    <div class="selected-constellation"></div>
                </div>
                <div class="col-12"><h3>All</h3></div>
                <div class="col-12"><canvas class="all-absmag"></canvas></div>
                <div class="col-12"><canvas class="all-mag"></canvas></div>
                <div class="col-12"><canvas class="all-rv"></canvas></div>
                <div class="col-12"><canvas class="all-lum"></canvas></div>
                <div class="col-12"><canvas class="all-ci"></canvas></div>
                <div class="col-12"><canvas class="all-hr"></canvas></div>
            </div>`
            document.querySelector('.constellations').prepend(allDiv)
            document.querySelector('.constellation-select').addEventListener('change', function() {
                const constellationId = this.value
                console.log('select constellation', constellationId)
                updateSelectedConstellation(starData, constellationId, true)
            })

            new Chart(document.querySelector(`.all-absmag`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.absmag.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.absmag.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - absmag - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-mag`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.mag.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.mag.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - mag - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-rv`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.rv.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.rv.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - rv - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-lum`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.lum.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.lum.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - lum - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            new Chart(document.querySelector(`.all-ci`), {
                type: 'line',
                data: {
                    labels: Array.from({
                        length: starData.ranges.ci.averages.length
                    }, (_, i) => i + 1),
                    datasets: starData.ranges.ci.constellationDiffListData.map((d,i) => ({
                        label: `${d.constellation} - ci - diff`,
                        backgroundColor: getColor(i),
                        borderColor: getColor(i),
                        data: d.data,
                        borderWidth: 1,
                        hidden: d.constellation === 'ALL'
                    }))
                }
            })
            // Slows loading, leave commented for now
            // new Chart(document.querySelector(`.all-hr`), {
            //     type: 'scatter',
            //     data: {
            //         datasets: starData.hrAllListData.map((d,i) => ({
            //             label: `${d.constellation} - hr`,
            //             backgroundColor: getColor(i),
            //             borderColor: getColor(i),
            //             data: d.data
            //         }))
            //     },
            //     options: {
            //         scales: {
            //             y: {
            //                 reverse: true,
            //                 min: -5,
            //                 max: 17
            //             }
            //         }
            //     }
            // })


            for (const button of document.querySelectorAll('.tone-clip')) {
                button.addEventListener('click', function() {
                    // console.log('this', this)\
                    getToneDataFromElementAndPlay(starData, this)
                })
            }

        }

        function starVertexShader() {
            return `
                attribute float size;
                attribute vec3 customColor;
                varying vec3 vColor;

                void main() {
                    vColor = customColor;
                    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
                    gl_PointSize = size * ( 300.0 / -mvPosition.z );
                    gl_Position = projectionMatrix * mvPosition;
                }
            `
        }

        function starFragmentShader() {
            return `
                uniform vec3 color;
                uniform sampler2D pointTexture;
                varying vec3 vColor;
                void main() {
                    gl_FragColor = vec4( color * vColor, 1.0 );
                    gl_FragColor = gl_FragColor * texture2D( pointTexture, gl_PointCoord );
                }
            `
        }


        const addStarMap = async (starData) => {

            const updateFovFromDistance = () => {
                camera.fov = 25 + (controls.getDistance()*30)
                camera.updateProjectionMatrix()
            }
            const focusMapOnConstellation = (constellation) => {
                controls.enabled = false;
                const newCamPos = new THREE.Vector3(constellation.centre.x,constellation.centre.y,constellation.centre.z).lerp(new THREE.Vector3(0,0,0), 1.2)
                camera.position.x = newCamPos.x
                camera.position.y = newCamPos.y
                camera.position.z = newCamPos.z
                camera.lookAt( controls.target )

                controls.enabled = true

                updateFovFromDistance()
            }

            starData.focusMapOnConstellation = focusMapOnConstellation

            // console.log('addStarMap', starData)
            var scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            var camera = new THREE.PerspectiveCamera(
                25, // Field of View
                1200 / 600, // aspect ratio
                0.001, // near clipping plane
                1000 // far clipping plane
            );
            var renderer = new THREE.WebGLRenderer({
                alpha: true, // transparent background
                antialias: true // smooth edges
            });
            renderer.setSize(1200, 600);
            document.querySelector('.star-map').appendChild(renderer.domElement);
            const labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize( 1200, 600 );
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none'
            document.querySelector('.star-map').appendChild( labelRenderer.domElement )

            const controls = new OrbitControls(camera, renderer.domElement);
            // controls.rotateSpeed *= -1; // This isn't working, should ideally be opposite up and down, scroll in / out, not pan
            controls.minDistance = 0
            controls.maxDistance = 1
            controls.zoomSpeed = 2
            // console.log('controls', controls)
            controls.addEventListener( 'change', function(change) {
                // camera.lookAt(new THREE.Vector3(0,0,0).lerp(camera.position, 2))
                updateFovFromDistance()
                // console.log('control change', controls.getDistance(), camera.fov)
            } );

            // var cube = new THREE.Mesh(new THREE.BoxGeometry(0.001, 0.001, 0.001), new THREE.MeshNormalMaterial())
            // scene.add(cube);

            // POINTS
            const sprite = new THREE.TextureLoader().load( 'disc.png' );

            const bufGeom = new THREE.BufferGeometry()
            const points = new THREE.Points(bufGeom, new THREE.ShaderMaterial({
            uniforms: {
            color: { value: new THREE.Color( 0xffffff ) },
            pointTexture: { value: new THREE.TextureLoader().load( 'disc.png' ) }
            },
            vertexShader: starVertexShader(),
            fragmentShader: starFragmentShader(),

            blending: THREE.AdditiveBlending,
            depthTest: false,
            transparent: true
            }))
            const pointsArray = []
            const colorsArray = []
            const sizesArray = []
            let targetCameraPos

            const centrePoints = []
            for (const constellation of starData.constellations) {//.filter(c => c.constellationName === 'Sagitta')) {

                const mainStarHips = constellation.starsMain.map(s => s.hip)
                for (const star of constellation.stars.filter(s => !mainStarHips.includes(s.hip))) {
                    pointsArray.push(star.ax, star.ay, star.az)
                    const s = ((star.mag * 26) / 255 + 0.18) / 75
                    // const s = 0.0125
                    sizesArray.push(s)
                    colorsArray.push(1,1,1,1)
                }
                for (const star of constellation.starsMain) {
                    pointsArray.push(star.ax, star.ay, star.az)
                    // const s = ((star.mag * 26) / 255 + 0.18) / 75
                    const s = 0.03
                    sizesArray.push(s)

                    if (star.alpha) {
                        colorsArray.push(1,0,0,1)
                    } else {
                        // colorsArray.push(0.82,0.89,1,1)
                        colorsArray.push(0,1,1,1)
                    }

                }
                pointsArray.push(constellation.centre.x, constellation.centre.y, constellation.centre.z)
                sizesArray.push(0.03)
                colorsArray.push(1,0,0,1)
                centrePoints.push({c: constellation.constellation, v: new THREE.Vector3(constellation.centre.x, constellation.centre.y, constellation.centre.z)})
            }
            // console.log('sizeArray', sizesArray)
            bufGeom.setAttribute('position', new THREE.Float32BufferAttribute(pointsArray, 3));
            bufGeom.setAttribute('customColor', new THREE.Float32BufferAttribute(colorsArray, 4));
            bufGeom.setAttribute('size', new THREE.Float32BufferAttribute(sizesArray, 1));

            scene.add(points)

            // LINES
            const lineMaterial = new LineMaterial({
                color: 0x1363DF,
                linewidth: 0.003
            })
            for (const constellation of starData.constellations) {
                for (const lines of constellation.lines) {
                    if(lines.points) {
                        const points = []
                        for (const point of lines.points) {
                            // points.push( new THREE.Vector3( point.x,point.y,point.z ) )
                            points.push(point.x,point.y,point.z)
                        }
                        // const lineGeom = new THREE.BufferGeometry().setFromPoints( points );
                        const lineGeom = new LineGeometry()
                        lineGeom.setPositions( points )
                        const line = new Line2( lineGeom, lineMaterial );
                        line.computeLineDistances();
                        line.scale.set( 1, 1, 1 );
                        scene.add( line );
                    }
                }

                const conDiv = document.createElement( 'div' );
                conDiv.className = 'label';
                conDiv.textContent = constellation.constellationName;

                // conDiv.style.marginTop = '-1em';
                const conLabel = new CSS2DObject( conDiv );
                conLabel.position.set( constellation.centre.x, constellation.centre.y, constellation.centre.z );
                scene.add( conLabel );

            }



            // SPHERE
            const sphere = new THREE.Mesh( new THREE.SphereGeometry( 1, 24, 13 ), new THREE.MeshPhongMaterial( { color: 0x12394C, side: THREE.DoubleSide, wireframe: true } ) )
            sphere.doubleSided = true;
            scene.add( sphere )
            scene.add( new THREE.AmbientLight( 0xFFFFFF ) )


            // TRIANGLES
            // for (const constellation of starData.constellations) {//.filter(c => c.constellationName === 'Ursa Major')) {
            //     const alpha = constellation.starsMain.find(s => s.alpha)
            //     const origin = {x: constellation.centre.x, y: constellation.centre.y, z: constellation.centre.z}
            //     // const origin = {x: alpha.ax, y: alpha.ay, z: alpha.az}
            //     const triGeom = new THREE.BufferGeometry()
            //     const triMesh = new THREE.Mesh(triGeom, new THREE.MeshBasicMaterial( {side: THREE.DoubleSide, transparent:false, color: 0xFFFFFF} ))
            //     const triPos = new Float32Array([0,0,0, origin.x,origin.y,origin.z, 0,1,0])
            //     triGeom.setAttribute('position', new THREE.BufferAttribute(triPos,3))
            //     scene.add(triMesh)
            //     for (const star of constellation.starsMain) {
            //         console.log('Angle to ', star.bayer, star.proper, '-', star.angleFromCentre, star.angleFromAlpha )
            //         const triGeom = new THREE.BufferGeometry()
            //         const triMesh = new THREE.Mesh(triGeom, new THREE.MeshBasicMaterial( {side: THREE.DoubleSide, transparent:false, color: 0xFF00FF} ))
            //         const triPos = new Float32Array([0,0,0, origin.x,origin.y,origin.z, star.ax, star.ay,star.az])
            //         triGeom.setAttribute('position', new THREE.BufferAttribute(triPos,3))
            //         scene.add(triMesh)
            //     }
            // }


            camera.lookAt(0,0,0)
            camera.position.z = 0.5; // move camera back so we can see the cube
            updateFovFromDistance()
            // camera.lookAt(new THREE.Vector3(0,0,0).lerp(camera.position, 2))

            // controls.update()

            // Ray casting
            const raycaster = new THREE.Raycaster();
            const pointer = new THREE.Vector2();
            function onPointerMove( event ) {
                pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
                pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
            }


            var render = function() {
                requestAnimationFrame(render)
                // controls.update()

                raycaster.setFromCamera( pointer, camera );
            	const intersects = raycaster.intersectObjects( [sphere] )
                if (intersects.length>0) {
                    const point = intersects[0].point
                    let dist = 100
                    let constellationId = ''
                    // console.log('point', point, centrePoints)
                    for (const centrePoint of centrePoints) {
                        const distPoint = centrePoint.v.distanceToSquared(point)
                        if(distPoint < dist ) {
                            dist = distPoint
                            constellationId = centrePoint.c
                        }
                    }
                    // console.log('Closest', constellationId)
                    updateSelectedConstellation(starData, constellationId, false)
                }



                renderer.render(scene, camera)
                labelRenderer.render( scene, camera )
            };
            updateSelectedConstellation(starData, starData.constellations[0].constellation, true)
            render();


        }
        const globalBindings = () => {
            document.body.addEventListener('keydown', function(e) {
                // console.log('e', e.code, e)
                if (e.code === 'Space' || e.code === 'Backspace' || e.code === 'Delete') {
                    stopToneClips()
                }
            })
        }
        const init = async () => {
            console.log('Fetching data')
            const starData = await (await fetch('/data/star-data.json')).json()
            // starData.constellations = starData.constellations.filter(c => c.constellation.includes('Peg'))
            console.log('Drawing Graphs', 'starData', starData)
            addConstellationGraphs(starData)
            console.log('Drawing Map')
            addStarMap(starData)
            globalBindings()
            console.log('Ready')
        }
        init()
    </script>

</body>

</html>